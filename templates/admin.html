<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Company Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
        background: linear-gradient(135deg, #667eea, #764ba2);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 440px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 40px 30px;
        text-align: center;
      }

      .content {
        padding: 40px 30px;
      }

      .screen {
        display: none;
      }

      .screen.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 15px;
      }

      .btn {
        width: 100%;
        padding: 14px;
        border-radius: 8px;
        border: none;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .error-message,
      .success-message {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: none;
      }

      .error-message {
        background: #fee2e2;
        color: #dc2626;
      }

      .success-message {
        background: #d1fae5;
        color: #059669;
      }

      .show {
        display: block;
      }

      .link-text {
        text-align: center;
        margin-top: 16px;
      }

      .link-text a {
        cursor: pointer;
        color: #667eea;
        font-weight: 600;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: #f3f4f6;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .admin-section {
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .admin-card {
        background: white;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        margin-top: 5px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- FIRST LOGIN -->
      <div id="firstLogin" class="screen active">
        <div class="header">
          <h1>Company Portal</h1>
        </div>
        <div class="content">
          <div id="firstLoginError" class="error-message"></div>

          <form id="firstLoginForm">
            <div class="form-group">
              <label>Email</label>
              <input id="companyEmail" type="email" required />
            </div>

            <div class="form-group">
              <label>Password</label>
              <input id="companyPassword" type="password" required />
            </div>

            <button class="btn btn-primary">Login</button>
          </form>
        </div>
      </div>

      <!-- USER CHOICE -->
      <div id="userChoice" class="screen">
        <div class="header">
          <h1>Welcome</h1>
        </div>
        <div class="content">
          <button class="btn btn-primary" onclick="showScreen('signIn')">
            Sign In
          </button>
          <button class="btn btn-primary" onclick="showScreen('signUp')">
            Sign Up
          </button>

          <div class="link-text">
            <a onclick="showScreen('firstLogin')">← Back</a>
          </div>
        </div>
      </div>

      <!-- SIGN IN -->
      <div id="signIn" class="screen">
        <div class="header">
          <h1>Sign In</h1>
        </div>
        <div class="content">
          <div id="signInError" class="error-message"></div>

          <form id="signInForm">
            <div class="form-group">
              <label>Username</label>
              <input id="signInName" required />
            </div>

            <div class="form-group">
              <label>Password</label>
              <input id="signInPassword" type="password" required />
            </div>

            <button class="btn btn-primary">Sign In</button>
          </form>

          <div class="link-text">
            <a onclick="showScreen('userChoice')">← Back</a>
          </div>
        </div>
      </div>

      <!-- SIGN UP -->
      <div id="signUp" class="screen">
        <div class="header">
          <h1>Sign Up</h1>
        </div>
        <div class="content">
          <div id="signUpError" class="error-message"></div>
          <div id="signUpSuccess" class="success-message"></div>

          <form id="signUpForm">
            <div class="form-group">
              <label>Username</label>
              <input id="signUpName" required />
            </div>

            <div class="form-group">
              <label>Password</label>
              <input id="signUpPassword" type="password" required />
            </div>

            <div class="form-group">
              <label>Confirm Password</label>
              <input id="signUpConfirmPassword" type="password" required />
            </div>

            <button class="btn btn-primary">Submit for Approval</button>
          </form>

          <div class="link-text">
            <a onclick="showScreen('userChoice')">← Back</a>
          </div>
        </div>
      </div>

      <!-- ADMIN PANEL -->
      <div id="adminPanel" class="screen">
        <div class="header">
          <h1>Admin Dashboard</h1>
        </div>

        <div class="content">
          <div class="stat-grid">
            <div class="stat-card">
              <h3 id="approvedCount">0</h3>
              <p>Approved</p>
            </div>

            <div class="stat-card">
              <h3 id="pendingCount">0</h3>
              <p>Pending</p>
            </div>
          </div>

          <div class="admin-section">
            <h3>Pending Requests</h3>
            <div id="pendingList"></div>
          </div>

          <div class="admin-section">
            <h3>Approved Users</h3>
            <div id="approvedList"></div>
          </div>

          <div class="link-text">
            <a onclick="showScreen('firstLogin')">Logout</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentUser = null;

      /* ================= UI ================= */

      function showScreen(id) {
        document.querySelectorAll(".screen").forEach((screen) => {
          screen.classList.remove("active");
        });
        document.getElementById(id).classList.add("active");
      }

      function showError(id, message) {
        const el = document.getElementById(id);
        el.textContent = message;
        el.classList.add("show");
      }

      /* ================= FIRST LOGIN ================= */

      document
        .getElementById("firstLoginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const response = await fetch("/api/first-login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: companyEmail.value,
              password: companyPassword.value,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            if (data.role === "admin") {
              showScreen("adminPanel");
              loadAdminPanel();
            } else {
              showScreen("userChoice");
            }
          } else {
            showError("firstLoginError", data.error);
          }
        });

      /* ================= SIGN UP ================= */

      document
        .getElementById("signUpForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (signUpPassword.value !== signUpConfirmPassword.value) {
            return showError("signUpError", "Passwords do not match");
          }

          const response = await fetch("/api/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: signUpName.value.trim(),
              password: signUpPassword.value,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            document.getElementById("signUpSuccess").textContent =
              "Request submitted!";
            document.getElementById("signUpSuccess").classList.add("show");
          } else {
            showError("signUpError", data.error);
          }
        });

      /* ================= SIGN IN ================= */

      document
        .getElementById("signInForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const response = await fetch("/api/signin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: signInName.value,
              password: signInPassword.value,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem("username", data.username);
            window.location.href = "/dashboard";
          } else {
            showError("signInError", data.error);
          }
        });

      /* ================= ADMIN PANEL ================= */

      async function loadAdminPanel() {
        const response = await fetch("/api/adminpanel");
        const data = await response.json();

        if (!response.ok) return;

        document.getElementById("approvedCount").textContent =
          data.approved_count;
        document.getElementById("pendingCount").textContent =
          data.pending_count;

        /* -------- Pending Users -------- */
        const pendingList = document.getElementById("pendingList");

        pendingList.innerHTML = data.pending.length
          ? data.pending
              .map(
                (user) => `
            <div class="admin-card">
                <strong>${user.username}</strong><br>
                <button class="btn-sm" 
                onclick="approveUser('${user.username}')">
                Approve</button>
            </div>
        `,
              )
              .join("")
          : "No pending users";

        /* -------- Approved Users -------- */
        const approvedList = document.getElementById("approvedList");

        approvedList.innerHTML = data.approved.length
          ? data.approved
              .map(
                (user) => `
            <div class="admin-card">
                <strong>${user.username}</strong>
                <p>Status: ${user.blocked ? "Blocked" : "Active"}</p>

                <button class="btn-sm" onclick="editUser('${user.username}')">Edit</button>
                <button class="btn-sm" onclick="toggleBlock('${user.username}')">
                    ${user.blocked ? "Unblock" : "Block"}
                </button>
                <button class="btn-sm" onclick="removeUser('${user.username}')">Remove</button>
            </div>
        `,
              )
              .join("")
          : "No approved users";
      }

      /* ================= ADMIN ACTIONS ================= */

      async function approveUser(username) {
        console.log("Approving:", username);

        const res = await fetch("/api/admin/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username }),
        });

        const data = await res.json();
        console.log("Response:", data);

        loadAdminPanel();
      }

      async function toggleBlock(username) {
        await fetch("/api/admin/block", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: username }),
        });

        loadAdminPanel();
      }

      async function removeUser(username) {
        if (!confirm("Remove this user permanently?")) return;

        await fetch("/api/admin/remove", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: username }),
        });

        loadAdminPanel();
      }
      async function editUser(oldUsername) {
        const newUsername = prompt("Enter new username:");
        const newPassword = prompt("Enter new password:");

        if (!newUsername || !newPassword) return;

        await fetch("/api/admin/edit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            oldUsername: oldUsername,
            newUsername: newUsername,
            newPassword: newPassword,
          }),
        });

        loadAdminPanel();
      }
    </script>
  </body>
</html>
